name: Generate T-Shirt Design

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 10 * * *'

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install openai==1.12.0 requests==2.31.0 Pillow==10.0.0
        python -c "import openai; print(f'OpenAI version: {openai.__version__}')"
    
    - name: Create designs directory
      run: mkdir -p designs
    
    - name: Run T-Shirt Generator
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PRINTFUL_API_KEY: ${{ secrets.PRINTFUL_API_KEY }}
        PRINTFUL_STORE_ID: ${{ secrets.PRINTFUL_STORE_ID }}
        MARKUP_PERCENT: ${{ secrets.MARKUP_PERCENT }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_PAGES_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
      run: |
        echo "🎨 Generating T-Shirt Design..."
        echo "📍 Repository: $GITHUB_REPOSITORY"
        echo "🌐 Pages URL: $GITHUB_PAGES_URL"
        python generate_tee.py
    
    - name: Commit generated designs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add all generated files
        git add designs/*.png designs/*.json || true
        git add *.log || true
        
        # Commit if there are changes
        if git diff --staged --quiet; then
          echo "No new designs to commit"
        else
          git commit -m "🎨 Add designs from run ${{ github.run_number }}"
          git push
        fi
    
    - name: Create index.html for designs
      run: |
        cat > designs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>T-Shirt Designs</title>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
                .design { border: 1px solid #ddd; padding: 10px; text-align: center; }
                img { max-width: 100%; height: auto; }
            </style>
        </head>
        <body>
            <h1>T-Shirt Design Gallery</h1>
            <div class="gallery" id="gallery"></div>
            <script>
                // This will be populated by GitHub Pages directory listing
                fetch('.')
                    .then(r => r.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const links = doc.querySelectorAll('a');
                        const gallery = document.getElementById('gallery');
                        
                        links.forEach(link => {
                            if (link.href.endsWith('.png')) {
                                const div = document.createElement('div');
                                div.className = 'design';
                                div.innerHTML = `<img src="${link.href}" alt="${link.textContent}">
                                               <p>${link.textContent}</p>`;
                                gallery.appendChild(div);
                            }
                        });
                    })
                    .catch(() => {
                        document.getElementById('gallery').innerHTML = '<p>No designs yet</p>';
                    });
            </script>
        </body>
        </html>
        EOF
        
        git add designs/index.html || true
        git commit -m "Update gallery" || true
        git push || true
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: designs-${{ github.run_number }}
        path: |
          designs/
          *.log
        retention-days: 30
    
    - name: Summary
      run: |
        echo "## 🎨 T-Shirt Generation Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**GitHub Pages URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
        echo "**Designs Gallery:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/designs/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
        ls -la designs/*.png 2>/dev/null | tail -5 >> $GITHUB_STEP_SUMMARY || echo "No designs found" >> $GITHUB_STEP_SUMMARY
